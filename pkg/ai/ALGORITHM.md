# AI 算法逻辑

## 概述

AI 控制器使用分层状态机和行为树的组合来实现智能决策。核心思想是**生存优先**，其次才是攻击和探索。

---

## 核心数据结构

### 1. 危险热力图 (DangerGrid)
- 维护每个格子的危险值 (0.0 - 1.0)
- 根据炸弹剩余时间动态计算危险度
- 即将爆炸的炸弹危险值更高

### 2. 状态变量
- `thinkInterval`: 思考间隔 (100ms)，用于性能优化
- `changeDirTicker`: 随机游走方向改变计时器
- `doorRevealed`: 门的发现状态

---

## 决策流程（优先级从高到低）

### 1. 生存优先 (Survival)
```
isInDanger → escape → findNearestSafeCell → getNextStep → moveToCell
```
- 检查当前位置是否在炸弹爆炸范围内
- 使用 **BFS** 搜索最近的安全格子
- 使用 **BFS 寻路**移动到安全区

### 2. 寻找门 (Endgame)
```
shouldGoToDoor → goToDoor → moveToTarget
```
- 门被发现且只剩自己存活
- 直接移动到门的位置

### 3. 攻击模式 (Attack)
```
findAttackTarget → moveToTarget / place bomb
```
- **优先敌人**：距离 < 5 格时，直接追击
- **其次砖块**：寻找最近的砖块

### 4. 探索模式 (Exploration)
```
findNearestBrick → moveToTarget → place bomb
```
- 寻找最近的砖块
- **关键**：返回砖块周围可到达的空格子位置
- 移动到该位置，放置炸弹破坏砖块

### 5. 兜底行为 (Fallback)
```
randomWalk
```
- 随机选择方向移动
- 每 0.5-1.5 秒改变一次方向

---

## 核心算法

### BFS 寻路 (getNextStep)
- **目的**：找到从当前位置到目标的最短路径
- **优势**：避免局部最优陷阱，能绕过障碍物
- **实现**：
  1. 队列存储待探索节点
  2. 记录已访问格子避免重复
  3. 回溯路径找到第一步
  4. 随机化搜索顺序避免死板

### 炸弹安全检查 (canPlaceBombSafely)
- **模拟爆炸**：计算炸弹爆炸范围
- **逃生验证**：使用 BFS 搜索安全点
- **条件**：
  - 当前位置无炸弹
  - 10 步内能找到安全点
  - 逃生路径不被其他炸弹阻挡

### 目标选择 (findNearestBrick)
- **遍历地图**：找到所有砖块
- **检查周围**：对每个砖块检查 4 个方向
- **可到达性**：选择最近的空格子位置
- **关键点**：不直接返回砖块坐标（障碍物）

---

## 像素级移动控制 (moveToCell)

### 轴对齐策略
```
1. 计算目标格子的像素中心坐标
2. 计算当前位置到目标的偏差
3. 优先移动偏差较大的方向
4. 防止同时斜向移动导致卡墙
```

### 防抖动
- 容差值：2.0 像素
- 避免在到达目标时来回抖动

---

## 性能优化

### 1. 思考频率控制
- 每 100ms 思考一次 (6 帧)
- 其他时间使用缓存的输入
- 减少 CPU 占用

### 2. 事件驱动更新
- 危险热力图只在炸弹状态变化时更新
- 避免每帧重新计算所有危险区

### 3. 搜索深度限制
- BFS 搜索限制在 20 格内
- 逃生搜索限制在 10 步内

---

## 行为树优先级

```
1. 生存 (高优先级，立即执行)
   ↓ 无危险
2. 寻找门 (中优先级，条件触发)
   ↓ 门未发现或非单人
3. 攻击 (中优先级)
   ↓ 敌人远且无砖块
4. 探索 (低优先级)
   ↓ 无目标
5. 随机游走 (兜底)
```

---

## 关键改进点

### 1. BFS 寻路替代贪心算法
- **问题**：贪心算法会撞墙、原地跳跃
- **解决**：BFS 找到最优路径，绕过障碍物

### 2. 智能目标选择
- **问题**：目标指向砖块本身（障碍物）
- **解决**：返回砖块周围可到达位置

### 3. 预演验证
- **问题**：放置炸弹后无逃生路径
- **解决**：模拟爆炸范围并 BFS 验证逃生

### 4. 平滑移动
- **问题**：像素级移动抖动、卡墙
- **解决**：轴对齐策略 + 容差控制

---

## 参数配置

| 参数 | 值 | 说明 |
|------|-----|------|
| `thinkInterval` | 0.1s | 思考间隔 |
| `dangerThreshold` | 0.05 | 危险判断阈值 |
| `enemyChaseDist` | 5 | 追击敌人的距离 |
| `escapeSearchDepth` | 20 | 逃命搜索深度 |
| `bombEscapeDepth` | 10 | 放炸弹后搜索深度 |
| `randomWalkDuration` | 0.5-1.5s | 随机游走持续时间 |

---

## 总结

AI 的核心思想是：
1. **活下去** → 躲避炸弹
2. **找目标** → 追击敌人或破坏砖块
3. **用对方法** → BFS 寻路而非贪心
4. **留后路** → 放炸弹前验证逃生路径

通过这些策略，AI 能够：
- 智能地绕过障碍物
- 安全地放置炸弹
- 有效地破坏砖块和追击敌人
- 避免愚蠢的死亡