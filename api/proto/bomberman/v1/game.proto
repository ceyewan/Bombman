syntax = "proto3";

package bomberman.game.v1;

option go_package = "bomberman/api/gen/bomberman/v1;gamev1";

// ========== 枚举定义 ==========

enum Direction {
  DIRECTION_UNSPECIFIED = 0; // 未指定
  DIRECTION_DOWN = 1; // 下 (对应 core.DirDown = 0)
  DIRECTION_UP = 2; // 上 (对应 core.DirUp = 1)
  DIRECTION_LEFT = 3; // 左 (对应 core.DirLeft = 2)
  DIRECTION_RIGHT = 4; // 右 (对应 core.DirRight = 3)
}

enum CharacterType {
  CHARACTER_TYPE_UNSPECIFIED = 0; // 未指定
  CHARACTER_TYPE_WHITE = 1; // 经典白色炸弹人 (core.CharacterWhite = 0)
  CHARACTER_TYPE_BLACK = 2; // 暗夜黑战士 (core.CharacterBlack = 1)
  CHARACTER_TYPE_RED = 3; // 烈焰红爆破专家 (core.CharacterRed = 2)
  CHARACTER_TYPE_BLUE = 4; // 冰霜蓝策略大师 (core.CharacterBlue = 3)
}

enum GamePhase {
  GAME_PHASE_UNSPECIFIED = 0; // 未指定
  GAME_PHASE_WAITING = 1; // 等待玩家
  GAME_PHASE_COUNTDOWN = 2; // 倒计时
  GAME_PHASE_PLAYING = 3; // 游戏中
  GAME_PHASE_GAME_OVER = 4; // 游戏结束
}

enum TileType {
  TILE_TYPE_UNSPECIFIED = 0; // 未指定
  TILE_TYPE_EMPTY = 1; // 空地
  TILE_TYPE_WALL = 2; // 不可破坏的墙
  TILE_TYPE_BRICK = 3; // 可破坏的砖块
  TILE_TYPE_DOOR = 4; // 门 (隐藏在砖块下，炸开后出现)
}

enum RoomStatus {
  ROOM_STATUS_UNSPECIFIED = 0;
  ROOM_STATUS_WAITING = 1; // 等待中，可加入
  ROOM_STATUS_PLAYING = 2; // 游戏中
}

enum RoomActionType {
  ROOM_ACTION_UNSPECIFIED = 0;
  ROOM_ACTION_LEAVE = 1; // 离开房间 -> 大厅
  ROOM_ACTION_READY = 2; // 准备/取消准备
  ROOM_ACTION_START = 3; // 开始游戏 (房主)
  ROOM_ACTION_ADD_AI = 4; // 添加 AI (房主)
  ROOM_ACTION_KICK = 5; // 踢人 (房主)
}

// ========== 客户端消息 ==========

message InputData {
  int32 frame_id = 1; // 客户端期望服务器应用的帧号（以服务器帧为基准）
  bool up = 2;
  bool down = 3;
  bool left = 4;
  bool right = 5;
  bool bomb = 6;
}

// 客户端输入封包（可包含多帧输入以应对网络延迟），seq 为这个输入包的序号
message ClientInput {
  int32 seq = 1; // 输入序号（单调递增）
  repeated InputData inputs = 2; // 多帧输入数据
}

// 加入游戏请求，包含玩家名称和选择的角色
message JoinRequest {
  string player_name = 1;
  CharacterType character = 2;
  // room_id 语义：
  // - ""        : 快速匹配（找一个 WAITING 且未满的房间，或创建新房间）
  // - "CREATE"  : 强制创建新房间
  // - "default" : 兼容模式（旧行为）
  // - "room_xxx": 加入指定房间
  string room_id = 3;
}

// 获取房间列表
message RoomListRequest {
  int32 page = 1;
  int32 page_size = 2; // 默认 20
}

// 房间操作
message RoomAction {
  RoomActionType type = 1;

  // 可选参数
  bool ready = 2; // READY: true=准备, false=取消
  int32 ai_count = 3; // ADD_AI: 添加数量
  int32 target_player = 4; // KICK: 目标玩家
}

// Ping-Pong 消息，用于测量延迟和时间同步，对表
message Ping {
  int64 client_time = 1; // 客户端时间戳（毫秒）
}

// 重连请求，用于断线后恢复会话
message ReconnectRequest {
  string session_token = 1; // 会话令牌（JWT）
}

// ========== 服务器消息 ==========

// 加入游戏响应，包含玩家 ID 和初始游戏配置
message JoinResponse {
  bool success = 1;
  int32 player_id = 2;
  string error_message = 3;

  // 初始游戏配置
  int64 game_seed = 4; // 地图随机种子
  int32 tps = 5; // 服务器 TPS，例如 60 Hz

  // 会话信息（用于重连）
  string session_token = 10; // 会话令牌（JWT），5 分钟有效

  // 房间信息
  string room_id = 11; // 实际加入的房间 ID
  RoomStateUpdate room_state = 12; // 房间当前状态
}

// 房间列表响应
message RoomListResponse {
  repeated RoomInfo rooms = 1;
  int32 total = 2;
}

// 房间信息
message RoomInfo {
  string id = 1;
  string name = 2;
  int32 current_players = 3;
  int32 ai_count = 4;
  int32 max_players = 5;
  RoomStatus status = 6;
  string host_name = 7;
}

// 房间操作响应
message RoomActionResponse {
  bool success = 1;
  string error_message = 2;
  string session_token = 3;
  string room_id = 4;
}

// 房间状态更新
message RoomStateUpdate {
  string room_id = 1;
  RoomStatus status = 2;
  repeated RoomPlayer players = 3;
  int32 host_id = 4;
}

// 房间内玩家信息
message RoomPlayer {
  int32 id = 1;
  string name = 2;
  CharacterType character = 3;
  bool is_ready = 4;
  bool is_host = 5;
  bool is_ai = 6;
}

// 完整游戏状态（定期发送或客户端请求）
message GameState {
  int32 frame_id = 1; // 服务器当前帧号
  GamePhase phase = 2; // 当前游戏阶段

  map<int32, int32> last_processed_seq = 3; // playerID -> 最后处理的输入序号

  // 实体状态
  repeated PlayerState players = 4;
  repeated BombState bombs = 5;
  repeated ExplosionState explosions = 6;

  // 地图变化（增量）
  repeated TileChange tile_changes = 7;

  // 对局结束帧（<=0 表示不启用限时）
  int32 match_end_frame = 8;
}

// 增量状态更新（高频发送）
message DeltaState {
  int32 frame_id = 1; // 服务器当前帧号
  int32 base_frame_id = 2; // 基于哪一帧的增量（服务器帧）

  map<int32, int32> last_processed_seq = 3;

  repeated PlayerDelta player_deltas = 4;
  repeated int32 removed_bomb_ids = 5;
  repeated BombState new_bombs = 6;
  repeated ExplosionState new_explosions = 7;
  repeated TileChange tile_changes = 8;
}

message PlayerState {
  int32 id = 1; // 玩家唯一 ID
  double x = 2; // 精确位置
  double y = 3; // 精确位置
  Direction direction = 4; // 朝向
  bool is_moving = 5; // 是否在移动
  bool dead = 6; // 是否死亡
  CharacterType character = 7; // 角色类型

  // 附加信息
  int32 next_placement_frame = 8; // 下一次可放置炸弹的帧号（服务器帧）
  int32 current_bombs = 9; // 当前放置的炸弹数
  int32 max_bombs = 10; // 最大可放置炸弹数
}

message PlayerDelta {
  int32 id = 1;

  // 可选字段，仅包含变化的部分
  optional double x = 2;
  optional double y = 3;
  optional Direction direction = 4;
  optional bool is_moving = 5;
  optional bool dead = 6;
}

message BombState {
  int32 id = 1; // 炸弹唯一 ID（用于增量更新）
  int32 grid_x = 2; // 网格位置
  int32 grid_y = 3; // 网格位置
  int32 explode_at_frame = 4; // 引爆帧号（服务器帧）
  int32 explosion_range = 5; // 爆炸范围
  int32 owner_id = 6; // 放置者玩家 ID
  int32 placed_at_frame = 7; // 放置帧号
}

message ExplosionState {
  int32 id = 1; // 爆炸唯一 ID
  repeated GridCell cells = 2; // 受影响的网格位置
  int32 expires_at_frame = 3; // 结束帧号（服务器帧）
  int32 created_at_frame = 4; // 创建帧号（服务器帧）
}

message GridCell {
  int32 x = 1; // 网格位置
  int32 y = 2; // 网格位置
}

message TileChange {
  int32 x = 1; // 网格位置
  int32 y = 2; // 网格位置
  TileType new_type = 3; // TileType 枚举值
}

// Ping-Pong 响应消息
message Pong {
  int64 client_time = 1; // 回传客户端时间
  int64 server_time = 2; // 服务器时间
  int32 server_frame = 3; // 当前服务器帧号
}

// 重连响应，包含完整游戏状态用于恢复
message ReconnectResponse {
  bool success = 1;
  string error_message = 2;

  // 完整游戏状态（用于恢复）
  GameState current_state = 3;
}

// ========== 游戏事件（可选，用于重要事件通知） ==========

message GameEvent {
  int32 frame_id = 1;

  oneof event {
    PlayerJoinedEvent player_joined = 2; // 玩家加入
    PlayerLeftEvent player_left = 3; // 玩家离开
    PlayerDiedEvent player_died = 4; // 玩家死亡
    BombPlacedEvent bomb_placed = 5; // 玩家放置炸弹
    BombExplodedEvent bomb_exploded = 6; // 炸弹爆炸
    GameStartEvent game_start = 7; // 游戏开始
    GameOverEvent game_over = 8; // 游戏结束
    RoomStateUpdate room_update = 10; // 房间状态变更
  }
}

message PlayerJoinedEvent {
  int32 player_id = 1;
  string player_name = 2;
}

message PlayerLeftEvent {
  int32 player_id = 1;
}

message PlayerDiedEvent {
  int32 player_id = 1;
  int32 killer_id = 2; // 炸弹所有者，-1 表示自杀
}

message BombPlacedEvent {
  int32 player_id = 1;
  int32 grid_x = 2;
  int32 grid_y = 3;
}

message BombExplodedEvent {
  int32 bomb_id = 1;
  repeated GridCell affected_cells = 2;
}

message GameStartEvent {
  int32 countdown_frames = 1;
}

message GameOverEvent {
  int32 winner_id = 1; // -1 表示平局
}

// ========== 消息包装 ==========

message Packet {
  MessageType type = 1;
  bytes payload = 2;
}

enum MessageType {
  MESSAGE_TYPE_UNSPECIFIED = 0;

  // 客户端 -> 服务器
  MESSAGE_TYPE_JOIN_REQUEST = 1;
  MESSAGE_TYPE_CLIENT_INPUT = 2;
  MESSAGE_TYPE_PING = 3;
  MESSAGE_TYPE_RECONNECT_REQUEST = 4;
  MESSAGE_TYPE_ROOM_LIST_REQUEST = 20;
  MESSAGE_TYPE_ROOM_ACTION = 22;

  // 服务器 -> 客户端
  MESSAGE_TYPE_JOIN_RESPONSE = 10;
  MESSAGE_TYPE_GAME_STATE = 11;
  MESSAGE_TYPE_GAME_EVENT = 12;
  MESSAGE_TYPE_PONG = 13;
  MESSAGE_TYPE_RECONNECT_RESPONSE = 14;
  MESSAGE_TYPE_ROOM_LIST_RESPONSE = 21;
  MESSAGE_TYPE_ROOM_ACTION_RESPONSE = 23;
  MESSAGE_TYPE_ROOM_STATE_UPDATE = 24;
}
